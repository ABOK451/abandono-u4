<h2 class="text-3xl font-bold underline mb-6 m-5">
  Resultados de la Predicción
</h2>

<!-- Tabs -->
<div class="space-y-6 px-5">
  <div
    class="grid w-full grid-cols-2 bg-white shadow-sm border rounded-md overflow-hidden"
  >
    <button
      (click)="activeTab = 'visualizations'"
      [ngClass]="{
        'bg-blue-100 text-blue-600 font-semibold':
          activeTab === 'visualizations',
        'hover:bg-gray-100': activeTab !== 'visualizations'
      }"
      class="flex items-center justify-center space-x-2 px-4 py-2 transition-colors"
    >
      <svg
        class="w-4 h-4"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        viewBox="0 0 24 24"
      >
        <path d="M4 6h16M4 12h8m-8 6h16"></path>
      </svg>
      <span>Visualizaciones</span>
    </button>

    <button
      (click)="activeTab = 'data'"
      [ngClass]="{
        'bg-blue-100 text-blue-600 font-semibold': activeTab === 'data',
        'hover:bg-gray-100': activeTab !== 'data'
      }"
      class="flex items-center justify-center space-x-2 px-4 py-2 transition-colors"
    >
      <svg
        class="w-4 h-4"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        viewBox="0 0 24 24"
      >
        <path
          d="M3 4a1 1 0 011-1h16a1 1 0 011 1v16a1 1 0 01-1 1H4a1 1 0 01-1-1V4z"
        ></path>
      </svg>
      <span>Datos</span>
    </button>
  </div>
</div>

<!-- Contenido de la pestaña: Datos -->
<div *ngIf="activeTab === 'data'" class="mt-6 px-5">
  <div class="overflow-auto max-h-[350px] rounded border border-gray-300">
    <table
      mat-table
      [dataSource]="resultados"
      class="min-w-full border-separate border-spacing-y-1 border-spacing-x-0"
    >
      <!-- Columnas -->
      <ng-container matColumnDef="nombre">
        <th
          mat-header-cell
          *matHeaderCellDef
          class="bg-gray-200 px-4 py-2 text-left font-semibold text-gray-700 rounded-tl-md"
        >
          Nombre
        </th>
        <td
          mat-cell
          *matCellDef="let row"
          class="px-4 py-2 border border-gray-300 bg-white even:bg-gray-50"
        >
          {{ row.nombre }}
        </td>
      </ng-container>

      <ng-container matColumnDef="riesgo">
        <th
          mat-header-cell
          *matHeaderCellDef
          class="bg-gray-200 px-4 py-2 text-left font-semibold text-gray-700"
        >
          Riesgo
        </th>
        <td
          mat-cell
          *matCellDef="let row"
          class="px-4 py-2 border border-gray-300 bg-white even:bg-gray-50"
        >
          {{ row.riesgo }}
        </td>
      </ng-container>

      <tr
        mat-header-row
        *matHeaderRowDef="['nombre', 'riesgo']"
        class="sticky top-0 z-10"
      ></tr>
      <tr
        mat-row
        *matRowDef="let row; columns: ['nombre', 'riesgo']"
        class="hover:bg-blue-50 transition"
      ></tr>
    </table>
  </div>

  <button
    mat-raised-button
    color="primary"
    (click)="exportarCSV()"
    class="mt-6"
  >
    Exportar resultados
  </button>
</div>

<!-- Contenido de la pestaña: Visualizaciones -->
<div *ngIf="activeTab === 'visualizations'" class="mt-6 px-5 mb-6">
  <div class="mt-6 px-5 space-y-6">
    <!-- Card de configuración -->
    <div class="bg-white/70 backdrop-blur-sm shadow-xl border rounded-lg p-6">
      <div class="mb-4">
        <h3
          class="flex items-center space-x-2 text-lg font-semibold text-blue-600"
        >
          <svg
            class="h-5 w-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path d="M4 6h16M4 12h8m-8 6h16" stroke-width="2"></path>
          </svg>
          <span>Configuración de Gráficos</span>
        </h3>
        <p class="text-sm text-gray-600">
          Personaliza tus visualizaciones seleccionando variables y tipo de
          gráfico
        </p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <!-- Tipo de gráfico -->
        <div class="space-y-2">
          <label class="text-sm font-medium text-slate-700"
            >Tipo de Gráfico</label
          >
          <select
            class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none"
            [(ngModel)]="chartType"
            (ngModelChange)="onChartTypeChange()"
          >
            <option value="pie">Circular</option>
            <option value="bar">Barras</option>
            <option value="scatter">Dispersión</option>
          </select>
        </div>

        <!-- Eje X -->
        <div class="space-y-2">
          <label class="text-sm font-medium text-slate-700">
            {{
              chartType === "scatter"
                ? "Eje X (Numérico)"
                : "Eje X (Categorías)"
            }}</label
          >
          <select
            [(ngModel)]="selectedXAxis"
            (change)="onXAxisChange()"
            class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none"
          >
            <!-- Para scatter plot, mostrar solo columnas numéricas -->
            <ng-container *ngIf="chartType === 'scatter'">
              <option value="">Selecciona una variable numérica</option>
              <option *ngFor="let col of columnasNumericas" [value]="col">
                {{ getColumnDisplayName(col) }}
              </option>
            </ng-container>

            <!-- Para otros tipos de gráfico, mostrar columnas categóricas -->
            <ng-container *ngIf="chartType !== 'scatter'">
              <option *ngFor="let col of columnasCateg" [value]="col">
                {{ getColumnDisplayName(col) }}
              </option>
            </ng-container>
          </select>
        </div>

        <div class="space-y-2" *ngIf="chartType === 'scatter'">
          <label class="text-sm font-medium text-slate-700"
            >Eje Y (Numérico)</label
          >
          <select
            [(ngModel)]="selectedYAxis"
            (change)="onChartTypeChange()"
            class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none"
          >
            <option value="">Selecciona una variable numérica</option>
            <option *ngFor="let col of columnasNumericas" [value]="col">
              {{ getColumnDisplayName(col) }}
            </option>
          </select>
        </div>

        <!-- Información adicional para scatter plot -->
        <div class="space-y-2" *ngIf="chartType === 'scatter'">
          <label class="text-sm font-medium text-slate-700">Información</label>
          <div class="text-xs text-gray-600 bg-blue-50 p-2 rounded">
            <p><strong>Variables numéricas disponibles:</strong></p>
            <ul class="list-disc list-inside mt-1">
              <li *ngFor="let col of columnasNumericas">
                {{ getColumnDisplayName(col) }}
              </li>
            </ul>
            <p class="mt-2" *ngIf="columnasNumericas.length < 2">
              ⚠️ Se necesitan al menos 2 variables numéricas para el gráfico de
              dispersión.
            </p>
          </div>
        </div>
      </div>

      <!--======================= GRAFICAS ===============================000 -->
      <div class="mt-6 mb-6">
        <!-- Grafica Pastel -->
        <app-result-grafia-pastel
          *ngIf="chartType === 'pie'"
          [pieData]="pieData"
          [view]="view"
        ></app-result-grafia-pastel>

        <!-- GRAFICA DE BARRAS -->

        <div *ngIf="chartType === 'bar'">
          <app-result-grafica-barras
            [barData]="barChartData"
            [xAxisLabel]="selectedXAxis"
            [yAxisLabel]="'Cantidad de personas'"
          ></app-result-grafica-barras>
        </div>

        <!-- SCATTER -->
        <app-result-grafica-dispersion
          *ngIf="chartType === 'scatter'"
          [bubbleData]="bubbleChartData"
          [xAxisLabel]="getColumnDisplayName(selectedXAxis)"
          [yAxisLabel]="getColumnDisplayName(selectedYAxis)"
          [view]="view"
        ></app-result-grafica-dispersion>
      </div>
    </div>
  </div>

  <!-- Mensaje de advertencia si no hay suficientes variables numéricas -->
  <div
    *ngIf="chartType === 'scatter' && columnasNumericas.length < 2"
    class="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-md"
  >
    <div class="flex items-center">
      <svg
        class="w-5 h-5 text-yellow-600 mr-2"
        fill="currentColor"
        viewBox="0 0 20 20"
      >
        <path
          fill-rule="evenodd"
          d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
          clip-rule="evenodd"
        />
      </svg>
      <span class="text-yellow-800">
        El gráfico de dispersión requiere al menos 2 variables numéricas.
        Actualmente tienes {{ columnasNumericas.length }} variable(s)
        numérica(s).
      </span>
    </div>
  </div>
</div>
